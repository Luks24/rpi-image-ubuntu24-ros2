name: ubuntu-ros2-pi5
mmdebstrap:
  mode: unshare
  suite: noble
  target: rootfs
  mirrors:
    - deb http://archive.raspberrypi.com/debian bookworm main
    - http://ports.ubuntu.com/ubuntu-ports noble main restricted universe multiverse
    - http://ports.ubuntu.com/ubuntu-ports noble-updates main restricted universe multiverse
    - http://ports.ubuntu.com/ubuntu-ports noble-security main restricted universe multiverse
  keyrings:
    - /usr/share/keyrings/ubuntu-archive-keyring.gpg
    - /usr/share/keyrings/ros-archive-keyring.gpg

  setup-hooks:
    # 1. Remove conflicting repositories FIRST
    - rm -f "$1/etc/apt/sources.list.d/ros2-testing.list"
    
    # 2. Add official ROS 2 Jazzy repository
    - mkdir -p "$1/usr/share/keyrings"
    - curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o "$1/usr/share/keyrings/ros-archive-keyring.gpg"
    - |-
      echo "deb [arch=arm64 signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu noble main" > "$1/etc/apt/sources.list.d/ros2.list"

    # 3. Enable universe repository
    - sed -i 's/main restricted universe multiverse/main restricted universe multiverse/' "$1/etc/apt/sources.list"

  packages:
    - raspberrypi-archive-keyring
    - ubuntu-minimal
    - systemd
    - linux-raspi
    - linux-firmware-raspi
    - network-manager
    - sudo
    - curl
    - locales
    - software-properties-common
    - build-essential
    - python3-pip
    - python3-rosdep
    - python3-colcon-common-extensions
    - ros-jazzy-ros-base

  customize-hooks:
    # Post-install fixes
    - chroot "$1" apt-get update
    - chroot "$1" apt-get -y --fix-broken install
    - chroot "$1" apt-get -y full-upgrade
    - chroot "$1" rosdep init
    - chroot "$1" runuser -u ubuntu -- rosdep update --include-eol-distros
    - echo "source /opt/ros/jazzy/setup.bash" >> "$1/etc/skel/.bashrc"

